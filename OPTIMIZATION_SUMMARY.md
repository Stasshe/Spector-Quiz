# Firebase書き込み回数削減最適化まとめ

## 実施した最適化内容

### 1. バッチ処理の活用
- **useLeader.ts**: 解答判定でのルーム状態更新をバッチ処理に統合
- **participationService.ts**: ルーム参加時のユーザー情報とルーム更新をバッチ処理に統合
- **useLeader.ts**: 早押し解答処理で全解答を一度のバッチで処理

### 2. 不要な`updatedAt`フィールド更新の削減
- 頻繁な状態変更（クイズ進行、解答状況など）では`updatedAt`を省略
- 重要な状態変更（ルーム開始、完了など）のみ`updatedAt`を更新

### 3. 統計更新の最適化
- **useLeader.ts**: クイズ統計の更新を非同期で実行し、失敗を許容
- **index.ts**: 重複した統計フラグ設定処理を削除
- **useLeader.ts**: 統計フラグの重複設定を削減

### 4. 非同期処理の活用
- 重要でない統計更新を非同期で実行
- エラーが発生してもゲーム進行に影響しないよう設計

### 5. 条件分岐による無駄な書き込み防止
- **index.ts**: 既にフラグが設定済みの場合は書き込みをスキップ
- **useQuizRoom.ts**: 不要なフラグリセット処理を削除

## 削減効果の見込み

### Before (改修前)
- 解答判定: 3-4回の個別書き込み
- ルーム参加: 2回の個別書き込み
- 早押し処理: 解答数分の個別書き込み
- 統計更新: 重複した複数回の書き込み

### After (改修後)
- 解答判定: 1回のバッチ書き込み + 非同期統計更新
- ルーム参加: 1回のバッチ書き込み
- 早押し処理: 1回のバッチ書き込み
- 統計更新: 条件分岐による重複防止

## 推定削減率
- **書き込み回数**: 約40-60%削減
- **特に効果が大きい箇所**:
  - 多人数での早押しクイズ（参加者数 × 削減率）
  - 頻繁なルーム状態更新
  - 統計情報の重複更新

## リアルタイム性の維持
- キャッシュは使用せず、リアルタイムリスナーを維持
- 重要な状態変更は即座に反映
- 統計情報のみ非同期処理で影響を最小化

## 注意事項
- エラーハンドリングは従来どおり維持
- ゲーム進行に影響する処理は確実性を重視
- バッチ処理失敗時のフォールバック処理を実装済み
