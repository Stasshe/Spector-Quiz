# Spector-Quiz アプリケーション仕様書

## 1. プロジェクト概要

### 1.1 アプリケーション概要
- アプリ名：Spector-Quiz
- 種類：オンラインマルチプレイヤークイズアプリケーション
- プラットフォーム：ウェブブラウザ（レスポンシブ対応）
- ホスティング：Vercel (Next.js アプリケーション)

### 1.2 主な機能
- リアルタイムマルチプレイヤー対戦クイズ
- 公式クイズ（世界史・日本史）とユーザー作成クイズ
- 早押し方式と記述式入力の2つの回答形式
- ジャンル・単元ベースのクイズ選択
- 経験値・スコアシステム
- ユーザープロフィール管理
- リアルタイムランキング

## 2. 技術スタック

### 2.1 フロントエンド
- **フレームワーク**: Next.js 14 (App Router)
- **言語**: TypeScript
- **スタイリング**: Tailwind CSS
- **状態管理**: React Context API
- **UI コンポーネント**: カスタムコンポーネント

### 2.2 バックエンド
- **データベース**: Firebase Firestore
- **認証**: Firebase Authentication
- **リアルタイム通信**: Firestore リアルタイムリスナー
- **ホスティング**: Vercel

### 2.3 アーキテクチャ
- **パターン**: ルームリーダーモデル
  - 各クイズルームに1名のリーダーが存在
  - リーダーがクイズ進行を制御
  - リーダー離脱時の自動移譲機能
- **データ構造**: 階層化されたコレクション
  - ジャンル > 単元 > クイズの3層構造
  - 公式クイズとユーザー作成クイズの分離

## 3. 機能要件

### 3.1 認証機能
- **ユーザー登録**: メールアドレス・パスワード
- **ログイン**: 自動ログイン機能付き
- **プロフィール管理**: ユーザー名、アイコン設定

### 3.2 クイズ機能
- **公式クイズ**:
  - 世界史（古代・中世・近世・近代・現代）
  - 日本史（古代・中世・近世・近代・現代）
  - YAMLファイルによる構造化データ
- **ユーザー作成クイズ**:
  - カスタムジャンル・単元の作成
  - 問題の作成・編集・削除
  - 複数の正解パターン対応

### 3.3 クイズルーム機能
- **ルーム作成**: ジャンル・単元選択によるルーム作成
- **参加機能**: ルームIDによる参加
- **リアルタイム同期**: 参加者状況のリアルタイム更新
- **早押し機能**: クリック時間による早押し判定
- **記述式回答**: テキスト入力による回答（正解パターンマッチング）

### 3.4 ゲーム進行機能
- **ルームリーダー制**: 最初の参加者がリーダー
- **自動進行**: リーダーによるクイズ開始・次問題移行
- **結果表示**: 各問題の結果とランキング
- **統計更新**: ゲーム終了時の経験値・スコア更新

### 3.5 ランキング・統計機能
- **グローバルランキング**: 全ユーザーのスコアランキング
- **ジャンル別統計**: ジャンルごとの得意・不得意分析
- **個人統計**: 参加回数、正答率、総獲得スコア

## 4. データベース設計

### 4.1 コレクション構造
```
firestore/
├── users/                              # ユーザー情報
├── genres/                             # ジャンル情報
│   ├── {genreId}/
│   │   ├── quiz_units/                 # ユーザー作成クイズ単元
│   │   └── official_quiz_units/        # 公式クイズ単元
├── quiz_rooms/                         # クイズルーム
├── user_stats/                         # ユーザー統計
└── rankings/                           # ランキング情報
```

### 4.2 主要なドキュメント構造

**users/{userId}**
```typescript
{
  uid: string;
  email: string;
  username: string;
  avatarUrl?: string;
  createdAt: Timestamp;
  lastLoginAt: Timestamp;
}
```

**quiz_rooms/{roomId}**
```typescript
{
  roomId: string;
  genre: string;
  unitId: string;
  classType: '公式' | 'ユーザー作成';
  quizType?: 'official' | 'user_created';
  roomLeaderId: string;
  status: 'waiting' | 'in_progress' | 'completed';
  participants: Record<string, Participant>;
  quizIds: string[];
  currentQuizIndex: number;
  createdAt: Timestamp;
}
```

## 5. セキュリティ設計

### 5.1 Firebase Security Rules
- **認証必須**: 全てのデータアクセスに認証要求
- **書き込み制限**: ユーザーは自分のデータのみ変更可能
- **ルーム制限**: 参加者のみルーム情報にアクセス可能

### 5.2 データ検証
- **入力値検証**: クライアントサイドでの基本検証
- **Firestore Rules**: サーバーサイドでの詳細検証

## 6. パフォーマンス設計

### 6.1 最適化戦略
- **リアルタイム同期**: 必要最小限のフィールドのみ監視
- **インデックス最適化**: クエリパフォーマンスの向上
- **データ分割**: 階層構造による効率的なデータアクセス

### 6.2 スケーラビリティ
- **ルーム自動削除**: 非アクティブルームの自動削除
- **統計データ最適化**: 集約データによる高速表示

## 7. 運用・保守

### 7.1 監視項目
- **Firebase使用量**: ストレージ・リード/ライト数
- **エラー率**: クライアントエラーの監視
- **レスポンス時間**: クイズ応答時間の監視

### 7.2 バックアップ・復旧
- **Firestore Export**: 定期的なデータエクスポート
- **設定管理**: 環境変数による設定管理

## 8. 今後の拡張予定

### 8.1 機能拡張
- **カスタムクイズ形式**: 四択問題の追加
- **チーム戦**: 複数人チームでの対戦機能
- **トーナメント**: 大会形式のクイズイベント

### 8.2 技術拡張
- **PWA対応**: オフライン機能の追加
- **プッシュ通知**: リアルタイム通知機能
- **AI機能**: 自動問題生成・難易度調整

